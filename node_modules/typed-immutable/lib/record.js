(function (factory) {
  if (typeof define === "function" && define.amd) {
    define(["exports", "./typed", "immutable"], factory);
  } else if (typeof exports !== "undefined") {
    factory(exports, require("./typed"), require("immutable"));
  }
})(function (exports, _typed, _immutable) {
  "use strict";

  var _slicedToArray = function (arr, i) { if (Array.isArray(arr)) { return arr; } else if (Symbol.iterator in Object(arr)) { var _arr = []; for (var _iterator = arr[Symbol.iterator](), _step; !(_step = _iterator.next()).done;) { _arr.push(_step.value); if (i && _arr.length === i) break; } return _arr; } else { throw new TypeError("Invalid attempt to destructure non-iterable instance"); } };

  var _defineProperty = function (obj, key, value) { return Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); };

  var _createComputedClass = (function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var prop = props[i]; prop.configurable = true; if (prop.value) prop.writable = true; Object.defineProperty(target, prop.key, prop); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; })();

  var _inherits = function (subClass, superClass) { if (typeof superClass !== "function" && superClass !== null) { throw new TypeError("Super expression must either be null or a function, not " + typeof superClass); } subClass.prototype = Object.create(superClass && superClass.prototype, { constructor: { value: subClass, enumerable: false, writable: true, configurable: true } }); if (superClass) subClass.__proto__ = superClass; };

  var _classCallCheck = function (instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } };

  var Typed = _typed.Typed;
  var typeOf = _typed.typeOf;
  var construct = _typed.construct;
  var Seq = _immutable.Seq;
  var Iterable = _immutable.Iterable;
  var Map = _immutable.Map;
  var Keyed = Iterable.Keyed;

  var Getter = function (key) {
    return function () {
      return this.get(key);
    };
  };

  var Setter = function (key) {
    return function (value) {
      if (!this.__ownerID) {
        throw TypeError("Cannot set on an immutable record.");
      }
      this.set(key, value);
    };
  };

  var $store = Typed.store;
  var $type = Typed.type;
  var $step = Typed.step;
  var $init = Typed.init;
  var $result = Typed.result;
  var $read = Typed.read;
  var $label = Typed.label;
  var $empty = Typed.empty;
  var $typeName = Typed.typeName;
  var $typeSignature = Typed.typeSignature;

  var TypedRecord = (function (_Iterable$Keyed) {
    function TypedRecord() {
      _classCallCheck(this, TypedRecord);
    }

    _inherits(TypedRecord, _Iterable$Keyed);

    _createComputedClass(TypedRecord, [{
      key: Typed.init,
      value: function () {
        return construct(this).asMutable();
      }
    }, {
      key: Typed.result,
      value: function (result) {
        return result.asImmutable();
      }
    }, {
      key: Typed.read,
      value: function () {
        var structure = arguments[0] === undefined ? {} : arguments[0];

        var Type = this.constructor;

        if (structure instanceof Type && structure.constructor === Type) {
          return structure;
        }

        if (!structure || typeof structure !== "object") {
          return TypeError("Invalid data structure \"" + structure + "\" was passed to " + this[$typeName]());
        }

        var seq = Seq(structure);
        var type = this[$type];

        var record = undefined;
        for (var key in type) {
          var fieldType = type[key];
          var value = seq.has(key) ? seq.get(key) : this.get(key);
          var result = fieldType[$read](value);

          if (result instanceof TypeError) {
            return TypeError("Invalid value for \"" + key + "\" field:\n " + result.message);
          }

          record = this[$step](record || this[$init](), [key, result]);
        }

        return this[$result](record);
      }
    }, {
      key: Typed.step,
      value: function (result, _ref) {
        var _ref2 = _slicedToArray(_ref, 2);

        var key = _ref2[0];
        var value = _ref2[1];

        var store = result[$store] ? result[$store].set(key, value) : new Map([[key, value]]);

        var record = result.__ownerID ? result : construct(result);
        record[$store] = store;

        return record;
      }
    }, {
      key: Typed.typeSignature,
      value: function () {
        var type = this[$type];
        var body = [];
        for (var key in type) {
          body.push("" + key + ": " + type[key][$typeName]());
        }

        return "Typed.Record({" + body.join(", ") + "})";
      }
    }, {
      key: Typed.typeName,
      value: function () {
        return this[$label] || this[$typeSignature]();
      }
    }, {
      key: "toString",
      value: function toString() {
        return this.__toString(this[$typeName]() + "({", "})");
      }
    }, {
      key: "has",
      value: function has(key) {
        return !!this[$type][key];
      }
    }, {
      key: "get",
      value: function get(key, defaultValue) {
        return !this[$type][key] ? defaultValue : !this[$store] ? defaultValue : this[$store].get(key, defaultValue);
      }
    }, {
      key: "clear",
      value: function clear() {
        if (this.__ownerID) {
          this[$store] && this[$store].clear();
          return this;
        }

        var RecordType = this.constructor;
        return this[$empty] || (RecordType[$empty] = new RecordType());
      }
    }, {
      key: "remove",
      value: function remove(key) {
        return this[$type][key] ? this.set(key, void 0) : this;
      }
    }, {
      key: "set",
      value: function set(key, value) {
        var fieldType = this[$type][key];

        if (!fieldType) {
          throw TypeError("Cannot set unknown field \"" + key + "\" on \"" + this[$typeName]() + "\"");
        }

        var result = fieldType[$read](value);

        if (result instanceof TypeError) {
          throw TypeError("Invalid value for " + key + " field: " + result.message);
        }

        return this[$step](this, [key, result]);
      }
    }, {
      key: "__iterator",
      value: function __iterator(type, reverse) {
        var _this = this;

        return Keyed(this[$type]).map(function (_, key) {
          return _this.get(key);
        }).__iterator(type, reverse);
      }
    }, {
      key: "__iterate",
      value: function __iterate(f, reverse) {
        var _this = this;

        return Keyed(this[$type]).map(function (_, key) {
          return _this.get(key);
        }).__iterate(f, reverse);
      }
    }, {
      key: "__ensureOwner",
      value: function __ensureOwner(ownerID) {
        if (ownerID === this.__ownerID) {
          return this;
        }

        var store = this[$store] && this[$store].__ensureOwner(ownerID);
        var result = !ownerID ? this : construct(this);

        result.__ownerID = ownerID;
        result[$store] = store;
        return result;
      }
    }, {
      key: "wasAltered",
      value: function wasAltered() {
        return this[$store].wasAltered();
      }
    }]);

    return TypedRecord;
  })(Iterable.Keyed);

  var Record = function Record(descriptor, label) {
    if (descriptor && typeof descriptor === "object") {
      var _ret = (function () {
        var type = Object.create(null);
        var keys = Object.keys(descriptor);
        var size = keys.length;

        if (size > 0) {
          var _ret2 = (function () {
            var properties = (function () {
              var _properties = {
                size: { value: size } };

              _defineProperty(_properties, $type, { value: type });

              _defineProperty(_properties, $label, { value: label });

              return _properties;
            })();

            var index = 0;
            while (index < size) {
              var key = keys[index];
              var fieldType = typeOf(descriptor[key]);

              if (fieldType) {
                type[key] = fieldType;
                properties[key] = { get: Getter(key), set: Setter(key), enumerable: true };
              } else {
                throw TypeError("Invalid field descriptor provided for a \"" + key + "\" field");
              }

              index = index + 1;
            }

            var RecordType = (function (_RecordType) {
              var _RecordTypeWrapper = function RecordType(_x) {
                return _RecordType.apply(this, arguments);
              };

              _RecordTypeWrapper.toString = function () {
                return _RecordType.toString();
              };

              return _RecordTypeWrapper;
            })(function (structure) {
              var isNew = this instanceof RecordType;
              var constructor = isNew ? this.constructor : RecordType;

              if (structure instanceof constructor) {
                return structure;
              }

              var type = constructor.prototype;
              var result = type[$read](structure);

              if (result instanceof TypeError) {
                throw result;
              }

              if (isNew) {
                this[$store] = result[$store];
              } else {
                return result;
              }
            });

            properties.constructor = { value: RecordType };
            RecordType.prototype = Object.create(RecordPrototype, properties);
            var prototype = RecordType.prototype;

            return {
              v: {
                v: RecordType
              }
            };
          })();

          if (typeof _ret2 === "object") return _ret2.v;
        } else {
          throw TypeError("Typed.Record descriptor must define at least on field");
        }
      })();

      if (typeof _ret === "object") {
        return _ret.v;
      }
    } else {
      throw TypeError("Typed.Record must be passed a descriptor of fields");
    }
  };
  exports.Record = Record;
  Record.Type = TypedRecord;
  Record.prototype = TypedRecord.prototype;
  var RecordPrototype = TypedRecord.prototype;

  RecordPrototype[Typed.DELETE] = RecordPrototype.remove;

  // Large part of the Record API is implemented by Immutabel.Map
  // and is just copied over.
  RecordPrototype.deleteIn = Map.prototype.deleteIn;
  RecordPrototype.removeIn = Map.prototype.removeIn;
  RecordPrototype.merge = Map.prototype.merge;
  RecordPrototype.mergeWith = Map.prototype.mergeWith;
  RecordPrototype.mergeIn = Map.prototype.mergeIn;
  RecordPrototype.mergeDeep = Map.prototype.mergeDeep;
  RecordPrototype.mergeDeepWith = Map.prototype.mergeDeepWith;
  RecordPrototype.mergeDeepIn = Map.prototype.mergeDeepIn;
  RecordPrototype.setIn = Map.prototype.setIn;
  RecordPrototype.update = Map.prototype.update;
  RecordPrototype.updateIn = Map.prototype.updateIn;
  RecordPrototype.withMutations = Map.prototype.withMutations;
  RecordPrototype.asMutable = Map.prototype.asMutable;
  RecordPrototype.asImmutable = Map.prototype.asImmutable;

  // Large chuck of API inherited from Iterable does not makes
  // much sense in the context of records so we undefine it.
  RecordPrototype.map = void 0;
  RecordPrototype.filter = void 0;
  RecordPrototype.filterNot = void 0;
  RecordPrototype.flip = void 0;
  RecordPrototype.mapKeys = void 0;
  RecordPrototype.mapEntries = void 0;
  RecordPrototype.sort = void 0;
  RecordPrototype.sortBy = void 0;
  RecordPrototype.reverse = void 0;
  RecordPrototype.slice = void 0;
  RecordPrototype.butLast = void 0;
  RecordPrototype.flatMap = void 0;
  RecordPrototype.flatten = void 0;
  RecordPrototype.rest = void 0;
  RecordPrototype.skip = void 0;
  RecordPrototype.skipLast = void 0;
  RecordPrototype.skipWhile = void 0;
  RecordPrototype.skipUntil = void 0;
  RecordPrototype.sortBy = void 0;
  RecordPrototype.take = void 0;
  RecordPrototype.takeLast = void 0;
  RecordPrototype.takeWhile = void 0;
  RecordPrototype.takeUntil = void 0;
});
//# sourceMappingURL=data:application/json;base64,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R0FBRyxLQUFLLENBQUMsQUFBQyxDQUFBO0FBQzlCLGlCQUFlLENBQUMsTUFBTSxHQUFHLEtBQUssQ0FBQyxBQUFDLENBQUE7QUFDaEMsaUJBQWUsQ0FBQyxPQUFPLEdBQUcsS0FBSyxDQUFDLEFBQUMsQ0FBQTtBQUNqQyxpQkFBZSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUMsQUFBQyxDQUFBO0FBQy9CLGlCQUFlLENBQUMsT0FBTyxHQUFHLEtBQUssQ0FBQyxBQUFDLENBQUE7QUFDakMsaUJBQWUsQ0FBQyxPQUFPLEdBQUcsS0FBSyxDQUFDLEFBQUMsQ0FBQTtBQUNqQyxpQkFBZSxDQUFDLE9BQU8sR0FBRyxLQUFLLENBQUMsQUFBQyxDQUFBO0FBQ2pDLGlCQUFlLENBQUMsSUFBSSxHQUFHLEtBQUssQ0FBQyxBQUFDLENBQUE7QUFDOUIsaUJBQWUsQ0FBQyxJQUFJLEdBQUcsS0FBSyxDQUFDLEFBQUMsQ0FBQTtBQUM5QixpQkFBZSxDQUFDLFFBQVEsR0FBRyxLQUFLLENBQUMsQUFBQyxDQUFBO0FBQ2xDLGlCQUFlLENBQUMsU0FBUyxHQUFHLEtBQUssQ0FBQyxBQUFDLENBQUE7QUFDbkMsaUJBQWUsQ0FBQyxTQUFTLEdBQUcsS0FBSyxDQUFDLEFBQUMsQ0FBQTtBQUNuQyxpQkFBZSxDQUFDLE1BQU0sR0FBRyxLQUFLLENBQUMsQUFBQyxDQUFBO0FBQ2hDLGlCQUFlLENBQUMsSUFBSSxHQUFHLEtBQUssQ0FBQyxBQUFDLENBQUE7QUFDOUIsaUJBQWUsQ0FBQyxRQUFRLEdBQUcsS0FBSyxDQUFDLEFBQUMsQ0FBQTtBQUNsQyxpQkFBZSxDQUFDLFNBQVMsR0FBRyxLQUFLLENBQUMsQUFBQyxDQUFBO0FBQ25DLGlCQUFlLENBQUMsU0FBUyxHQUFHLEtBQUssQ0FBQyxBQUFDLENBQUEiLCJmaWxlIjoic3JjL3JlY29yZC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7VHlwZWQsIHR5cGVPZiwgY29uc3RydWN0fSBmcm9tIFwiLi90eXBlZFwiXG5pbXBvcnQge1NlcSwgSXRlcmFibGUsIE1hcH0gZnJvbSAnaW1tdXRhYmxlJ1xuXG5jb25zdCB7S2V5ZWR9ID0gSXRlcmFibGVcblxuY29uc3QgR2V0dGVyID0ga2V5ID0+IGZ1bmN0aW9uKCkge1xuICByZXR1cm4gdGhpcy5nZXQoa2V5KVxufVxuXG5jb25zdCBTZXR0ZXIgPSBrZXkgPT4gZnVuY3Rpb24odmFsdWUpIHtcbiAgaWYgKCF0aGlzLl9fb3duZXJJRCkge1xuICAgIHRocm93IFR5cGVFcnJvcihcIkNhbm5vdCBzZXQgb24gYW4gaW1tdXRhYmxlIHJlY29yZC5cIilcbiAgfVxuICB0aGlzLnNldChrZXksIHZhbHVlKVxufVxuXG5cbmNvbnN0ICRzdG9yZSA9IFR5cGVkLnN0b3JlXG5jb25zdCAkdHlwZSA9IFR5cGVkLnR5cGVcbmNvbnN0ICRzdGVwID0gVHlwZWQuc3RlcFxuY29uc3QgJGluaXQgPSBUeXBlZC5pbml0XG5jb25zdCAkcmVzdWx0ID0gVHlwZWQucmVzdWx0XG5jb25zdCAkcmVhZCA9IFR5cGVkLnJlYWRcbmNvbnN0ICRsYWJlbCA9IFR5cGVkLmxhYmVsXG5jb25zdCAkZW1wdHkgPSBUeXBlZC5lbXB0eVxuY29uc3QgJHR5cGVOYW1lID0gVHlwZWQudHlwZU5hbWVcbmNvbnN0ICR0eXBlU2lnbmF0dXJlID0gVHlwZWQudHlwZVNpZ25hdHVyZVxuXG5jbGFzcyBUeXBlZFJlY29yZCBleHRlbmRzIEl0ZXJhYmxlLktleWVkIHtcbiAgY29uc3RydWN0b3IoKSB7fVxuICBbVHlwZWQuaW5pdF0oKSB7XG4gICAgcmV0dXJuIGNvbnN0cnVjdCh0aGlzKS5hc011dGFibGUoKVxuICB9XG4gIFtUeXBlZC5yZXN1bHRdKHJlc3VsdCkge1xuICAgIHJldHVybiByZXN1bHQuYXNJbW11dGFibGUoKVxuICB9XG5cbiAgW1R5cGVkLnJlYWRdKHN0cnVjdHVyZT17fSkge1xuICAgIGNvbnN0IFR5cGUgPSB0aGlzLmNvbnN0cnVjdG9yXG5cbiAgICBpZiAoc3RydWN0dXJlIGluc3RhbmNlb2YgVHlwZSAmJiBzdHJ1Y3R1cmUuY29uc3RydWN0b3IgPT09IFR5cGUpIHtcbiAgICAgIHJldHVybiBzdHJ1Y3R1cmVcbiAgICB9XG5cbiAgICBpZiAoIXN0cnVjdHVyZSB8fCB0eXBlb2Yoc3RydWN0dXJlKSAhPT0gXCJvYmplY3RcIikge1xuICAgICAgcmV0dXJuIFR5cGVFcnJvcihgSW52YWxpZCBkYXRhIHN0cnVjdHVyZSBcIiR7c3RydWN0dXJlfVwiIHdhcyBwYXNzZWQgdG8gJHt0aGlzWyR0eXBlTmFtZV0oKX1gKVxuICAgIH1cblxuICAgIGNvbnN0IHNlcSA9IFNlcShzdHJ1Y3R1cmUpXG4gICAgY29uc3QgdHlwZSA9IHRoaXNbJHR5cGVdXG5cbiAgICBsZXQgcmVjb3JkXG4gICAgZm9yIChsZXQga2V5IGluIHR5cGUpIHtcbiAgICAgIGNvbnN0IGZpZWxkVHlwZSA9IHR5cGVba2V5XVxuICAgICAgY29uc3QgdmFsdWUgPSBzZXEuaGFzKGtleSkgPyBzZXEuZ2V0KGtleSkgOiB0aGlzLmdldChrZXkpXG4gICAgICBjb25zdCByZXN1bHQgPSBmaWVsZFR5cGVbJHJlYWRdKHZhbHVlKVxuXG4gICAgICBpZiAocmVzdWx0IGluc3RhbmNlb2YgVHlwZUVycm9yKSB7XG4gICAgICAgIHJldHVybiBUeXBlRXJyb3IoYEludmFsaWQgdmFsdWUgZm9yIFwiJHtrZXl9XCIgZmllbGQ6XFxuICR7cmVzdWx0Lm1lc3NhZ2V9YClcbiAgICAgIH1cblxuICAgICAgcmVjb3JkID0gdGhpc1skc3RlcF0ocmVjb3JkIHx8IHRoaXNbJGluaXRdKCksIFtrZXksIHJlc3VsdF0pXG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXNbJHJlc3VsdF0ocmVjb3JkKVxuICB9XG4gIFtUeXBlZC5zdGVwXShyZXN1bHQsIFtrZXksIHZhbHVlXSkge1xuICAgIGNvbnN0IHN0b3JlID0gcmVzdWx0WyRzdG9yZV0gPyByZXN1bHRbJHN0b3JlXS5zZXQoa2V5LCB2YWx1ZSkgOlxuICAgICAgICAgICAgICAgICAgbmV3IE1hcChbW2tleSwgdmFsdWVdXSlcblxuICAgIGNvbnN0IHJlY29yZCA9IHJlc3VsdC5fX293bmVySUQgPyByZXN1bHQgOiBjb25zdHJ1Y3QocmVzdWx0KVxuICAgIHJlY29yZFskc3RvcmVdID0gc3RvcmVcblxuICAgIHJldHVybiByZWNvcmRcbiAgfVxuXG4gIFtUeXBlZC50eXBlU2lnbmF0dXJlXSgpIHtcbiAgICBjb25zdCB0eXBlID0gdGhpc1skdHlwZV1cbiAgICBjb25zdCBib2R5ID0gW11cbiAgICBmb3IgKGxldCBrZXkgaW4gdHlwZSkge1xuICAgICAgYm9keS5wdXNoKGAke2tleX06ICR7dHlwZVtrZXldWyR0eXBlTmFtZV0oKX1gKVxuICAgIH1cblxuICAgIHJldHVybiBgVHlwZWQuUmVjb3JkKHske2JvZHkuam9pbignLCAnKX19KWBcbiAgfVxuXG4gIFtUeXBlZC50eXBlTmFtZV0oKSB7XG4gICAgcmV0dXJuIHRoaXNbJGxhYmVsXSB8fCB0aGlzWyR0eXBlU2lnbmF0dXJlXSgpXG4gIH1cblxuICB0b1N0cmluZygpIHtcbiAgICByZXR1cm4gdGhpcy5fX3RvU3RyaW5nKHRoaXNbJHR5cGVOYW1lXSgpICsgJyh7JywgJ30pJylcbiAgfVxuXG4gIGhhcyhrZXkpIHtcbiAgICByZXR1cm4gISF0aGlzWyR0eXBlXVtrZXldXG4gIH1cblxuICBnZXQoa2V5LCBkZWZhdWx0VmFsdWUpIHtcbiAgICByZXR1cm4gIXRoaXNbJHR5cGVdW2tleV0gPyBkZWZhdWx0VmFsdWUgOlxuICAgICAgICAgICAhdGhpc1skc3RvcmVdID8gZGVmYXVsdFZhbHVlIDpcbiAgICAgICAgICAgdGhpc1skc3RvcmVdLmdldChrZXksIGRlZmF1bHRWYWx1ZSk7XG4gIH1cblxuICBjbGVhcigpIHtcbiAgICBpZiAodGhpcy5fX293bmVySUQpIHtcbiAgICAgIHRoaXNbJHN0b3JlXSAmJiB0aGlzWyRzdG9yZV0uY2xlYXIoKVxuICAgICAgcmV0dXJuIHRoaXNcbiAgICB9XG5cbiAgICBjb25zdCBSZWNvcmRUeXBlID0gdGhpcy5jb25zdHJ1Y3RvclxuICAgIHJldHVybiB0aGlzWyRlbXB0eV0gfHxcbiAgICAgICAgICAgKFJlY29yZFR5cGVbJGVtcHR5XSA9IG5ldyBSZWNvcmRUeXBlKCkpXG4gIH1cblxuICByZW1vdmUoa2V5KSB7XG4gICAgcmV0dXJuIHRoaXNbJHR5cGVdW2tleV0gPyB0aGlzLnNldChrZXksIHZvaWQoMCkpIDogdGhpc1xuICB9XG5cbiAgc2V0KGtleSwgdmFsdWUpIHtcbiAgICBjb25zdCBmaWVsZFR5cGUgPSB0aGlzWyR0eXBlXVtrZXldXG5cbiAgICBpZiAoIWZpZWxkVHlwZSkge1xuICAgICAgdGhyb3cgVHlwZUVycm9yKGBDYW5ub3Qgc2V0IHVua25vd24gZmllbGQgXCIke2tleX1cIiBvbiBcIiR7dGhpc1skdHlwZU5hbWVdKCl9XCJgKVxuICAgIH1cblxuICAgIGNvbnN0IHJlc3VsdCA9IGZpZWxkVHlwZVskcmVhZF0odmFsdWUpXG5cbiAgICBpZiAocmVzdWx0IGluc3RhbmNlb2YgVHlwZUVycm9yKSB7XG4gICAgICB0aHJvdyBUeXBlRXJyb3IoYEludmFsaWQgdmFsdWUgZm9yICR7a2V5fSBmaWVsZDogJHtyZXN1bHQubWVzc2FnZX1gKVxuICAgIH1cblxuICAgIHJldHVybiB0aGlzWyRzdGVwXSh0aGlzLCBba2V5LCByZXN1bHRdKVxuICB9XG4gIF9faXRlcmF0b3IodHlwZSwgcmV2ZXJzZSkge1xuICAgIHJldHVybiBLZXllZCh0aGlzWyR0eXBlXSkubWFwKChfLCBrZXkpID0+IHRoaXMuZ2V0KGtleSkpLl9faXRlcmF0b3IodHlwZSwgcmV2ZXJzZSk7XG4gIH1cblxuICBfX2l0ZXJhdGUoZiwgcmV2ZXJzZSkge1xuICAgIHJldHVybiBLZXllZCh0aGlzWyR0eXBlXSkubWFwKChfLCBrZXkpID0+IHRoaXMuZ2V0KGtleSkpLl9faXRlcmF0ZShmLCByZXZlcnNlKTtcbiAgfVxuXG4gIF9fZW5zdXJlT3duZXIob3duZXJJRCkge1xuICAgIGlmIChvd25lcklEID09PSB0aGlzLl9fb3duZXJJRCkge1xuICAgICAgcmV0dXJuIHRoaXNcbiAgICB9XG5cbiAgICBjb25zdCBzdG9yZSA9IHRoaXNbJHN0b3JlXSAmJiB0aGlzWyRzdG9yZV0uX19lbnN1cmVPd25lcihvd25lcklEKVxuICAgIGNvbnN0IHJlc3VsdCA9ICFvd25lcklEID8gdGhpcyA6IGNvbnN0cnVjdCh0aGlzKVxuXG4gICAgcmVzdWx0Ll9fb3duZXJJRCA9IG93bmVySURcbiAgICByZXN1bHRbJHN0b3JlXSA9IHN0b3JlXG4gICAgcmV0dXJuIHJlc3VsdFxuICB9XG4gIHdhc0FsdGVyZWQoKSB7XG4gICAgcmV0dXJuIHRoaXNbJHN0b3JlXS53YXNBbHRlcmVkKClcbiAgfVxufVxuXG5leHBvcnQgY29uc3QgUmVjb3JkID0gZnVuY3Rpb24oZGVzY3JpcHRvciwgbGFiZWwpIHtcbiAgaWYgKGRlc2NyaXB0b3IgJiYgdHlwZW9mKGRlc2NyaXB0b3IpID09PSBcIm9iamVjdFwiKSB7XG4gICAgY29uc3QgdHlwZSA9IE9iamVjdC5jcmVhdGUobnVsbClcbiAgICBjb25zdCBrZXlzID0gT2JqZWN0LmtleXMoZGVzY3JpcHRvcilcbiAgICBjb25zdCBzaXplID0ga2V5cy5sZW5ndGhcblxuICAgIGlmIChzaXplID4gMCkge1xuICAgICAgY29uc3QgcHJvcGVydGllcyA9IHtcbiAgICAgICAgc2l6ZToge3ZhbHVlOiBzaXplfSxcbiAgICAgICAgWyR0eXBlXToge3ZhbHVlOiB0eXBlfSxcbiAgICAgICAgWyRsYWJlbF06IHt2YWx1ZTogbGFiZWx9XG4gICAgICB9XG5cbiAgICAgIGxldCBpbmRleCA9IDBcbiAgICAgIHdoaWxlIChpbmRleCA8IHNpemUpIHtcbiAgICAgICAgY29uc3Qga2V5ID0ga2V5c1tpbmRleF1cbiAgICAgICAgY29uc3QgZmllbGRUeXBlID0gdHlwZU9mKGRlc2NyaXB0b3Jba2V5XSlcblxuICAgICAgICBpZiAoZmllbGRUeXBlKSB7XG4gICAgICAgICAgdHlwZVtrZXldID0gZmllbGRUeXBlXG4gICAgICAgICAgcHJvcGVydGllc1trZXldID0ge2dldDpHZXR0ZXIoa2V5KSwgc2V0OlNldHRlcihrZXkpLCBlbnVtZXJhYmxlOiB0cnVlfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRocm93IFR5cGVFcnJvcihgSW52YWxpZCBmaWVsZCBkZXNjcmlwdG9yIHByb3ZpZGVkIGZvciBhIFwiJHtrZXl9XCIgZmllbGRgKVxuICAgICAgICB9XG5cbiAgICAgICAgaW5kZXggPSBpbmRleCArIDFcbiAgICAgIH1cblxuICAgICAgY29uc3QgUmVjb3JkVHlwZSA9IGZ1bmN0aW9uKHN0cnVjdHVyZSkge1xuICAgICAgICBjb25zdCBpc05ldyA9IHRoaXMgaW5zdGFuY2VvZiBSZWNvcmRUeXBlXG4gICAgICAgIGNvbnN0IGNvbnN0cnVjdG9yID0gaXNOZXcgPyB0aGlzLmNvbnN0cnVjdG9yIDogUmVjb3JkVHlwZVxuXG4gICAgICAgIGlmIChzdHJ1Y3R1cmUgaW5zdGFuY2VvZiBjb25zdHJ1Y3Rvcikge1xuICAgICAgICAgIHJldHVybiBzdHJ1Y3R1cmVcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHR5cGUgPSBjb25zdHJ1Y3Rvci5wcm90b3R5cGVcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gdHlwZVskcmVhZF0oc3RydWN0dXJlKVxuXG4gICAgICAgIGlmIChyZXN1bHQgaW5zdGFuY2VvZiBUeXBlRXJyb3IpIHtcbiAgICAgICAgICB0aHJvdyByZXN1bHRcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChpc05ldykge1xuICAgICAgICAgIHRoaXNbJHN0b3JlXSA9IHJlc3VsdFskc3RvcmVdXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmV0dXJuIHJlc3VsdFxuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIHByb3BlcnRpZXMuY29uc3RydWN0b3IgPSB7dmFsdWU6IFJlY29yZFR5cGV9XG4gICAgICBSZWNvcmRUeXBlLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoUmVjb3JkUHJvdG90eXBlLCBwcm9wZXJ0aWVzKVxuICAgICAgY29uc3QgcHJvdG90eXBlID0gUmVjb3JkVHlwZS5wcm90b3R5cGVcblxuICAgICAgcmV0dXJuIFJlY29yZFR5cGVcbiAgICB9IGVsc2Uge1xuICAgICAgdGhyb3cgVHlwZUVycm9yKGBUeXBlZC5SZWNvcmQgZGVzY3JpcHRvciBtdXN0IGRlZmluZSBhdCBsZWFzdCBvbiBmaWVsZGApXG4gICAgfVxuICB9IGVsc2Uge1xuICAgIHRocm93IFR5cGVFcnJvcihgVHlwZWQuUmVjb3JkIG11c3QgYmUgcGFzc2VkIGEgZGVzY3JpcHRvciBvZiBmaWVsZHNgKVxuICB9XG59XG5SZWNvcmQuVHlwZSA9IFR5cGVkUmVjb3JkXG5SZWNvcmQucHJvdG90eXBlID0gVHlwZWRSZWNvcmQucHJvdG90eXBlXG5jb25zdCBSZWNvcmRQcm90b3R5cGUgPSBUeXBlZFJlY29yZC5wcm90b3R5cGVcblxuXG5SZWNvcmRQcm90b3R5cGVbVHlwZWQuREVMRVRFXSA9IFJlY29yZFByb3RvdHlwZS5yZW1vdmVcblxuLy8gTGFyZ2UgcGFydCBvZiB0aGUgUmVjb3JkIEFQSSBpcyBpbXBsZW1lbnRlZCBieSBJbW11dGFiZWwuTWFwXG4vLyBhbmQgaXMganVzdCBjb3BpZWQgb3Zlci5cblJlY29yZFByb3RvdHlwZS5kZWxldGVJbiA9IE1hcC5wcm90b3R5cGUuZGVsZXRlSW5cblJlY29yZFByb3RvdHlwZS5yZW1vdmVJbiA9IE1hcC5wcm90b3R5cGUucmVtb3ZlSW5cblJlY29yZFByb3RvdHlwZS5tZXJnZSA9IE1hcC5wcm90b3R5cGUubWVyZ2VcblJlY29yZFByb3RvdHlwZS5tZXJnZVdpdGggPSBNYXAucHJvdG90eXBlLm1lcmdlV2l0aFxuUmVjb3JkUHJvdG90eXBlLm1lcmdlSW4gPSBNYXAucHJvdG90eXBlLm1lcmdlSW5cblJlY29yZFByb3RvdHlwZS5tZXJnZURlZXAgPSBNYXAucHJvdG90eXBlLm1lcmdlRGVlcFxuUmVjb3JkUHJvdG90eXBlLm1lcmdlRGVlcFdpdGggPSBNYXAucHJvdG90eXBlLm1lcmdlRGVlcFdpdGhcblJlY29yZFByb3RvdHlwZS5tZXJnZURlZXBJbiA9IE1hcC5wcm90b3R5cGUubWVyZ2VEZWVwSW5cblJlY29yZFByb3RvdHlwZS5zZXRJbiA9IE1hcC5wcm90b3R5cGUuc2V0SW5cblJlY29yZFByb3RvdHlwZS51cGRhdGUgPSBNYXAucHJvdG90eXBlLnVwZGF0ZVxuUmVjb3JkUHJvdG90eXBlLnVwZGF0ZUluID0gTWFwLnByb3RvdHlwZS51cGRhdGVJblxuUmVjb3JkUHJvdG90eXBlLndpdGhNdXRhdGlvbnMgPSBNYXAucHJvdG90eXBlLndpdGhNdXRhdGlvbnNcblJlY29yZFByb3RvdHlwZS5hc011dGFibGUgPSBNYXAucHJvdG90eXBlLmFzTXV0YWJsZVxuUmVjb3JkUHJvdG90eXBlLmFzSW1tdXRhYmxlID0gTWFwLnByb3RvdHlwZS5hc0ltbXV0YWJsZVxuXG4vLyBMYXJnZSBjaHVjayBvZiBBUEkgaW5oZXJpdGVkIGZyb20gSXRlcmFibGUgZG9lcyBub3QgbWFrZXNcbi8vIG11Y2ggc2Vuc2UgaW4gdGhlIGNvbnRleHQgb2YgcmVjb3JkcyBzbyB3ZSB1bmRlZmluZSBpdC5cblJlY29yZFByb3RvdHlwZS5tYXAgPSB2b2lkKDApXG5SZWNvcmRQcm90b3R5cGUuZmlsdGVyID0gdm9pZCgwKVxuUmVjb3JkUHJvdG90eXBlLmZpbHRlck5vdCA9IHZvaWQoMClcblJlY29yZFByb3RvdHlwZS5mbGlwID0gdm9pZCgwKVxuUmVjb3JkUHJvdG90eXBlLm1hcEtleXMgPSB2b2lkKDApXG5SZWNvcmRQcm90b3R5cGUubWFwRW50cmllcyA9IHZvaWQoMClcblJlY29yZFByb3RvdHlwZS5zb3J0ID0gdm9pZCgwKVxuUmVjb3JkUHJvdG90eXBlLnNvcnRCeSA9IHZvaWQoMClcblJlY29yZFByb3RvdHlwZS5yZXZlcnNlID0gdm9pZCgwKVxuUmVjb3JkUHJvdG90eXBlLnNsaWNlID0gdm9pZCgwKVxuUmVjb3JkUHJvdG90eXBlLmJ1dExhc3QgPSB2b2lkKDApXG5SZWNvcmRQcm90b3R5cGUuZmxhdE1hcCA9IHZvaWQoMClcblJlY29yZFByb3RvdHlwZS5mbGF0dGVuID0gdm9pZCgwKVxuUmVjb3JkUHJvdG90eXBlLnJlc3QgPSB2b2lkKDApXG5SZWNvcmRQcm90b3R5cGUuc2tpcCA9IHZvaWQoMClcblJlY29yZFByb3RvdHlwZS5za2lwTGFzdCA9IHZvaWQoMClcblJlY29yZFByb3RvdHlwZS5za2lwV2hpbGUgPSB2b2lkKDApXG5SZWNvcmRQcm90b3R5cGUuc2tpcFVudGlsID0gdm9pZCgwKVxuUmVjb3JkUHJvdG90eXBlLnNvcnRCeSA9IHZvaWQoMClcblJlY29yZFByb3RvdHlwZS50YWtlID0gdm9pZCgwKVxuUmVjb3JkUHJvdG90eXBlLnRha2VMYXN0ID0gdm9pZCgwKVxuUmVjb3JkUHJvdG90eXBlLnRha2VXaGlsZSA9IHZvaWQoMClcblJlY29yZFByb3RvdHlwZS50YWtlVW50aWwgPSB2b2lkKDApXG4iXX0=